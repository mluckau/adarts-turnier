{% extends "base.html" %}

{% block title %}Darts Turnier - Startseite{% endblock %}

{% block content %}
    <h1 class="mb-4">Willkommen beim Darts Turnier!</h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    Neues Turnier erstellen
                </div>
                <div class="card-body">
                    <form action="{{ url_for('main.create_tournament') }}" method="post">
                        <div class="mb-3">
                            <label for="tournament_name" class="form-label">Turniername</label>
                            <input type="text" class="form-control" id="tournament_name" name="tournament_name" value="{{ default_tournament_name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="tournament_mode" class="form-label">Turniermodus</label>
                            <select class="form-select" id="tournament_mode" name="tournament_mode">
                                <option value="round_robin" selected>Jeder gegen Jeden (Round Robin)</option>
                                <option value="knockout" disabled>K.O.-System (Coming Soon)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="player_names" class="form-label mb-0">Spielernamen (einer pro Zeile)</label>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="shuffle-btn" title="Namen mischen">ðŸ”€ Mischen</button>
                            </div>
                            <textarea class="form-control" id="player_names" name="player_names" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Turnier starten</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Bekannte Spieler
                </div>
                <div class="card-body">
                    {% if known_player_names %}
                        <div id="known-players-list">
                            {% for name in known_player_names %}
                                <button type="button" class="btn btn-sm btn-outline-primary m-1 add-player-btn" data-player-name="{{ name }}">{{ name }}</button>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>Noch keine Spieler erfasst. Erstelle ein Turnier, um Spieler hinzuzufÃ¼gen.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Vergangene Turniere
                </div>
                <ul class="list-group list-group-flush">
                    {% for tournament in tournaments %}
                        <a href="{{ url_for('main.tournament_view', tournament_id=tournament.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                {{ tournament.name }}
                                {% if tournament.is_finished %}
                                    <span class="badge bg-success ms-2">Beendet</span>
                                {% else %}
                                    <span class="badge bg-primary ms-2">LÃ¤uft</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ tournament.date_created.strftime('%d.%m.%Y %H:%M') }}</small>
                        </a>
                    {% else %}
                        <li class="list-group-item">Keine Turniere gefunden.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const addPlayerButtons = document.querySelectorAll('.add-player-btn');
        const playerNamesTextarea = document.getElementById('player_names');
        const shuffleBtn = document.getElementById('shuffle-btn');

        // Shuffle Function (Fisher-Yates)
        shuffleBtn.addEventListener('click', () => {
            let names = playerNamesTextarea.value.trim().split('\n').map(n => n.trim()).filter(n => n);
            if (names.length < 2) return;

            for (let i = names.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [names[i], names[j]] = [names[j], names[i]];
            }
            playerNamesTextarea.value = names.join('\n');
        });

        addPlayerButtons.forEach(button => {
            button.addEventListener('click', () => {
                const playerName = button.dataset.playerName;
                let currentNames = playerNamesTextarea.value.trim();
                let namesArray = currentNames ? currentNames.split('\n').map(name => name.trim()) : [];

                if (!namesArray.includes(playerName)) {
                    if (currentNames) {
                        playerNamesTextarea.value += '\n' + playerName;
                    } else {
                        playerNamesTextarea.value = playerName;
                    }
                }
                // Optional: Scroll to bottom
                playerNamesTextarea.scrollTop = playerNamesTextarea.scrollHeight;
            });
        });
    });
</script>
{% endblock %}