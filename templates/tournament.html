{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Turnieransicht{% endblock %}

{% block content %}
    <style>
        .match-card {
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }

        .match-card.match-completed {
            background-color: var(--bs-tertiary-bg); /* Leicht abgedunkelt/grau */
            opacity: 0.85;
            border-color: transparent;
        }

        .match-highlight {
            border: 2px solid #ffc107 !important; /* Warning color border */
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.3) !important;
            transform: scale(1.02);
            z-index: 10;
        }

        /* Specific selector to override match-completed styles */
        div.match-card.match-highlight-completed {
            border: 2px solid #198754 !important; /* Success color border (Green) */
            box-shadow: 0 0 15px rgba(25, 135, 84, 0.5) !important;
            transform: scale(1.02);
            z-index: 20;
            opacity: 1 !important;
            /* Removed background-color: #d1e7dd !important; */
        }

        .match-playable {
            border: 2px solid #198754 !important; /* Success color (Green) */
            box-shadow: 0 0 15px rgba(25, 135, 84, 0.4) !important;
            transform: scale(1.02);
            z-index: 5;
        }
        
        .match-playable::after {
            content: "M√∂glich";
            position: absolute;
            top: -10px;
            right: 10px;
            background: #198754;
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .match-blocked {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .player-container {
            display: flex;
            align-items: center;
            flex: 1;
            font-weight: 600;
        }

        .player-left {
            justify-content: flex-end;
            text-align: right;
        }

        .player-right {
            justify-content: flex-start;
            text-align: left;
        }

        .player-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--bs-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 10px;
            flex-shrink: 0;
            text-transform: uppercase;
        }
        
        .player-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px; /* Mehr Platz f√ºr Namen */
            font-size: 0.95rem; /* Etwas kleiner */
        }
        /* Auf Mobile Namen etwas kleiner */
        @media (max-width: 576px) {
            .player-name { font-size: 0.85rem; max-width: 80px; }
            .player-avatar { width: 30px; height: 30px; font-size: 0.8rem; margin: 0 5px; }
            .match-card { padding: 10px 5px; }
        }

        .score-container {
            flex: 0 0 120px; /* Feste Breite f√ºr die Mitte etwas reduziert */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .vs-badge {
            font-size: 0.8rem;
            color: var(--bs-secondary-color);
            font-weight: bold;
            text-transform: uppercase;
        }

        .score-display {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--bs-heading-color);
        }

        .edit-btn-wrapper {
            position: absolute;
            margin-left: 60px; /* Neben dem Score platzieren */
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .match-card:hover .edit-btn-wrapper {
            opacity: 1;
        }

    </style>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ tournament.name }}</h1>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Zur√ºck zur √úbersicht</a>
    </div>

    {% if tournament.mode == 'round_robin' %}
    {% if tournament.is_finished %}
        <div class="row mb-5 justify-content-center">
            <div class="col-md-8 text-center">
                <h2>Siegerehrung</h2>
                <div class="d-flex justify-content-center align-items-end" style="height: 300px;">
                    {% if standings|length >= 2 %}
                    <div class="p-3 bg-secondary text-white d-flex flex-column justify-content-end align-items-center shadow" style="height: 60%; width: 30%; margin-right: 5px; border-radius: 5px 5px 0 0;">
                        <div class="fw-bold fs-4">2</div>
                        <div class="text-truncate" style="max-width: 100%;">{{ standings[1].player.name }}</div>
                        <div class="small">{{ standings[1].points }} Pkt</div>
                    </div>
                    {% endif %}
                    
                    {% if standings|length >= 1 %}
                    <div class="p-3 bg-warning text-dark d-flex flex-column justify-content-end align-items-center shadow-lg" style="height: 80%; width: 30%; z-index: 10; border-radius: 5px 5px 0 0;">
                        <div class="display-4"><i class="bi bi-trophy-fill"></i></div>
                        <div class="fw-bold fs-3">1</div>
                        <div class="fw-bold text-truncate" style="max-width: 100%;">{{ standings[0].player.name }}</div>
                        <div class="small">{{ standings[0].points }} Pkt</div>
                    </div>
                    {% endif %}
                    
                    {% if standings|length >= 3 %}
                    <div class="p-3 bg-danger text-white d-flex flex-column justify-content-end align-items-center shadow" style="height: 40%; width: 30%; margin-left: 5px; border-radius: 5px 5px 0 0; background-color: #cd7f32 !important;">
                        <div class="fw-bold fs-4">3</div>
                        <div class="text-truncate" style="max-width: 100%;">{{ standings[2].player.name }}</div>
                        <div class="small">{{ standings[2].points }} Pkt</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0">Spiele</h5>
                    <span class="badge bg-secondary ms-2" style="font-size: 0.7em; vertical-align: middle;">
                        {{ completed_matches }} / {{ total_matches }} gespielt
                    </span>
                    {% if not tournament.is_finished %}
                        {% if all_matches_completed %}
                             <form action="{{ url_for('main.finish_tournament', tournament_id=tournament.id) }}" method="post" style="display: inline;">
                                <button type="submit" class="btn btn-success btn-sm fw-bold px-3" onclick="return confirm('Bist du sicher? Das Turnier wird beendet und Ergebnisse k√∂nnen nicht mehr ge√§ndert werden.')">Turnier beenden</button>
                             </form>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-success">Turnier Beendet</span>
                    {% endif %}
                </div>
                                <div class="card-body bg-light-subtle">
                                    {% if matches_by_round %}
                                        <div class="matches-list">
                                            <div class="row">
                                            {% for round_num, round_matches in matches_by_round.items() %}
                                                {% for match in round_matches %}
                                                    <div class="col-xl-6">
                                                        <div class="match-card shadow-sm match-item {% if match.completed %}match-completed{% endif %}"
                                                             id="match-{{ match.id }}"
                                                             data-player1="{{ match.player1.name }}"
                                                             data-player2="{{ match.player2.name }}"
                                                             data-completed="{{ 'true' if match.completed else 'false' }}">
                                                            
                                                            <div class="position-absolute top-0 start-0 m-2 text-muted small fw-bold" style="font-size: 0.7rem; opacity: 1;">
                                                                #{{ match.display_number }}
                                                            </div>

                                                            <div class="d-flex justify-content-between align-items-center">
                                                                
                                                                <!-- Player 1 (Left) -->
                                                                <div class="player-container player-left {% if match.completed and match.score_player1 > match.score_player2 %}fw-bold text-success{% endif %}">
                                                                    <span class="player-name badge-hover-target" style="cursor: pointer;" data-player="{{ match.player1.name }}">{{ match.player1.name }}</span>
                                                                    <div class="player-avatar ms-2 badge-hover-target" style="cursor: pointer;" data-player="{{ match.player1.name }}">{{ match.player1.name[0] }}</div>
                                                                </div>
                    
                                                                <!-- Score / Inputs (Center) -->
                                                                <div class="score-container">
                                                                    {% if tournament.is_finished %}
                                                                        <div class="score-display">{{ match.score_player1 }} - {{ match.score_player2 }}</div>
                                                                    {% else %}
                                                                        {% if match.completed %}
                                                                            <div class="score-display me-2 score-editable" 
                                                                                 data-bs-toggle="modal" data-bs-target="#scoreModal"
                                                                                 data-bs-match-id="{{ match.id }}"
                                                                                 data-bs-p1-name="{{ match.player1.name }}"
                                                                                 data-bs-p2-name="{{ match.player2.name }}"
                                                                                 data-bs-p1-score="{{ match.score_player1 }}"
                                                                                 data-bs-p2-score="{{ match.score_player2 }}"
                                                                                 title="Klicken zum Bearbeiten">
                                                                                {{ match.score_player1 }} - {{ match.score_player2 }}
                                                                            </div>
                                                                        {% else %}
                                                                            <button type="button" class="btn btn-primary btn-sm rounded-pill px-3"
                                                                                    data-bs-toggle="modal" data-bs-target="#scoreModal"
                                                                                    data-bs-match-id="{{ match.id }}"
                                                                                    data-bs-p1-name="{{ match.player1.name }}"
                                                                                    data-bs-p2-name="{{ match.player2.name }}">
                                                                                Eingeben
                                                                            </button>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                </div>                
                                                                <!-- Player 2 (Right) -->
                                                                <div class="player-container player-right {% if match.completed and match.score_player2 > match.score_player1 %}fw-bold text-success{% endif %}">
                                                                    <div class="player-avatar me-2 badge-hover-target" style="cursor: pointer;" data-player="{{ match.player2.name }}">{{ match.player2.name[0] }}</div>
                                                                    <span class="player-name badge-hover-target" style="cursor: pointer;" data-player="{{ match.player2.name }}">{{ match.player2.name }}</span>
                                                                </div>
                    
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                            </div>
                                        </div>
                                    {% else %}
                        <p class="text-center text-muted py-4">Keine Spiele vorhanden.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px; z-index: 1;">
                <div class="card-header bg-transparent border-bottom py-3">
                    <h5 class="mb-0 text-body-secondary"><span class="me-2">üèÜ</span>Tabelle</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% if standings %}
                        {% for player_standing in standings %}
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3"
                                style="
                                {% if loop.index == 1 %}background-color: rgba(255, 193, 7, 0.2); border-left: 4px solid #ffc107;{% endif %}
                                {% if loop.index == 2 %}background-color: rgba(173, 181, 189, 0.2); border-left: 4px solid #adb5bd;{% endif %}
                                {% if loop.index == 3 %}background-color: rgba(205, 127, 50, 0.2); border-left: 4px solid #cd7f32;{% endif %}
                                ">
                                
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold text-muted me-3 d-flex justify-content-center fs-5" style="width: 30px;">
                                        {% if loop.index == 1 %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>
                                        {% elif loop.index == 2 %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-star-fill text-secondary" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>
                                        {% elif loop.index == 3 %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#cd7f32" class="bi bi-star-fill" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>
                                        {% else %}
                                            {{ loop.index }}.
                                        {% endif %}
                                    </span>
                                    <div class="player-avatar badge-hover-target shadow-sm" style="width: 30px; height: 30px; font-size: 0.8rem; background-color: var(--bs-primary); color: white; cursor: pointer;" data-player="{{ player_standing.player.name }}">{{ player_standing.player.name[0] }}</div>
                                    <span class="fw-bold ms-2 badge-hover-target" style="cursor: pointer;" data-player="{{ player_standing.player.name }}">{{ player_standing.player.name }}</span>
                                    {% if not tournament.is_finished and player_standing.open_matches > 0 %}
                                        <span class="badge bg-info bg-opacity-25 text-info ms-2 border border-info-subtle" style="font-size: 0.65em; font-weight: normal;" title="Noch {{ player_standing.open_matches }} offene Spiele">
                                            {{ player_standing.open_matches }}
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <div class="d-flex justify-content-end mb-1 align-items-center">
                                        <span class="badge bg-success bg-opacity-75 text-white me-1" title="Gewonnen">{{ player_standing.wins }}</span>
                                        <span class="badge bg-secondary bg-opacity-50 text-dark me-1" title="Unentschieden">{{ player_standing.draws }}</span>
                                        <span class="badge bg-danger bg-opacity-75 text-white" title="Verloren">{{ player_standing.losses }}</span>
                                    </div>
                                    <div>
                                        <small class="text-muted me-2 fw-semibold">{{ player_standing.legs_won }}:{{ player_standing.legs_lost }}</small>
                                        <span class="badge bg-primary rounded-pill shadow-sm">{{ player_standing.points }} Pkt</span>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item">Keine Platzierungen verf√ºgbar.</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    {% elif tournament.mode == 'knockout' %}
        <style>
            .bracket-container {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 20px;
            }
            .bracket-round {
                display: flex;
                flex-direction: column;
                min-width: 200px;
                margin-right: 20px;
                flex: 1;
            }
            .bracket-matches-wrapper {
                display: flex;
                flex-direction: column;
                justify-content: center;
                flex: 1;
                gap: 20px;
            }
            .bracket-round-title {
                text-align: center;
                font-weight: bold;
                margin-bottom: 15px;
                color: var(--bs-secondary);
            }
            .bracket-match {
                background: var(--bs-body-bg);
                border: 1px solid var(--bs-border-color);
                border-radius: 8px;
                padding: 8px;
                padding-right: 15px;
                position: relative;
                overflow: visible;
            }
            .bracket-player {
                display: flex;
                justify-content: space-between;
                padding: 2px 0;
            }
            .bracket-player.winner {
                font-weight: bold;
                color: var(--bs-success);
            }
            .bracket-score {
                font-weight: bold;
            }
            .bracket-edit-btn {
                position: absolute;
                right: -12px;
                top: 50%;
                transform: translateY(-50%);
                width: 24px;
                height: 24px;
                border-radius: 50%;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                z-index: 10;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
        </style>

        <div class="card shadow-sm border-0 mb-4">
             <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">Turnierbaum</h5>
                {% if not tournament.is_finished %}
                    {% if all_matches_completed %}
                         <form action="{{ url_for('main.finish_tournament', tournament_id=tournament.id) }}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-success btn-sm fw-bold px-3" onclick="return confirm('Turnier beenden?')">Turnier beenden</button>
                         </form>
                    {% endif %}
                {% else %}
                    <span class="badge bg-success">Turnier Beendet</span>
                {% endif %}
            </div>
            <div class="card-body bg-light-subtle" style="overflow-x: auto;">
                <div class="bracket-container">
                    {% for round_num, round_matches in matches_by_round.items() %}
                        <div class="bracket-round">
                            <div class="bracket-round-title">
                                {% if loop.last %}Finale{% elif loop.revindex == 2 %}Halbfinale{% elif loop.revindex == 3 %}Viertelfinale{% else %}Runde {{ round_num }}{% endif %}
                            </div>
                            <div class="bracket-matches-wrapper">
                            {% for match in round_matches %}
                                {% if match.round_number > 1 or match.player2 %}
                                    <div class="bracket-match shadow-sm {% if match.completed %}border-success border-opacity-25{% endif %}">
                                        <div class="bracket-player {% if match.completed and match.score_player1 > match.score_player2 %}winner{% endif %}">
                                            <span class="text-truncate" style="max-width: 150px;">
                                                {{ match.player1.name if match.player1 else 'TBD' }}
                                            </span>
                                            <span class="bracket-score">{{ match.score_player1 }}</span>
                                        </div>
                                        <div class="bracket-player {% if match.completed and match.score_player2 > match.score_player1 %}winner{% endif %}">
                                            <span class="text-truncate" style="max-width: 150px;">
                                                {{ match.player2.name if match.player2 else 'TBD' }}
                                            </span>
                                            <span class="bracket-score">{{ match.score_player2 }}</span>
                                        </div>
                                        
                                        {% if not match.completed and match.player1 and match.player2 %}
                                            <button class="btn btn-primary bracket-edit-btn" 
                                                    data-bs-toggle="modal" data-bs-target="#scoreModal"
                                                    data-bs-match-id="{{ match.id }}"
                                                    data-bs-p1-name="{{ match.player1.name }}"
                                                    data-bs-p2-name="{{ match.player2.name }}"
                                                    title="Ergebnis eintragen">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block scripts %}
    <!-- Score Input Modal -->
    <div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scoreModalLabel">Ergebnis eintragen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="scoreForm" method="post" action="">
                    <div class="modal-body">
                        <div class="row align-items-center mb-3">
                            <div class="col-5 text-end">
                                <label for="score_player1" class="form-label fw-bold mb-0" id="label_player1">Player 1</label>
                            </div>
                            <div class="col-2 text-center">
                                <span class="text-muted">vs</span>
                            </div>
                            <div class="col-5 text-start">
                                <label for="score_player2" class="form-label fw-bold mb-0" id="label_player2">Player 2</label>
                            </div>
                        </div>
                        <div class="row g-2 justify-content-center">
                            <div class="col-4">
                                <input type="number" class="form-control text-center fs-4" id="score_player1" name="score_player1" required min="0" value="0">
                            </div>
                            <div class="col-auto align-self-center">
                                <span class="fs-4">:</span>
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control text-center fs-4" id="score_player2" name="score_player2" required min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const badges = document.querySelectorAll('.badge-hover-target');
            const matchCards = document.querySelectorAll('.match-item');

            // Modal Logic
            const scoreModal = document.getElementById('scoreModal');
            if (scoreModal) {
                scoreModal.addEventListener('show.bs.modal', event => {
                    const button = event.relatedTarget;
                    const matchId = button.getAttribute('data-bs-match-id');
                    const p1Name = button.getAttribute('data-bs-p1-name');
                    const p2Name = button.getAttribute('data-bs-p2-name');
                    const p1Score = button.getAttribute('data-bs-p1-score');
                    const p2Score = button.getAttribute('data-bs-p2-score');

                    const form = scoreModal.querySelector('#scoreForm');
                    const labelP1 = scoreModal.querySelector('#label_player1');
                    const labelP2 = scoreModal.querySelector('#label_player2');
                    const inputP1 = scoreModal.querySelector('#score_player1');
                    const inputP2 = scoreModal.querySelector('#score_player2');

                    form.action = `/update_score/${matchId}`;
                    labelP1.textContent = p1Name;
                    labelP2.textContent = p2Name;
                    
                    if (p1Score && p1Score !== 'None') {
                        inputP1.value = p1Score;
                    } else {
                        inputP1.value = '0';
                    }
                    
                    if (p2Score && p2Score !== 'None') {
                        inputP2.value = p2Score;
                    } else {
                        inputP2.value = '0';
                    }
                });
            }

            // 1. Hover √ºber Spielernamen (Badge) -> Zeige alle Spiele DIESES Spielers (Gelb)
            badges.forEach(badge => {
                badge.addEventListener('mouseenter', (e) => {
                    // Eventuelle Klick-Highlights entfernen, um Konflikte zu vermeiden
                    resetClickedMatchStyles();

                    const playerName = badge.dataset.player;
                    matchCards.forEach(match => {
                        const isParticipant = (match.dataset.player1 === playerName || match.dataset.player2 === playerName);
                        const isCompleted = (match.dataset.completed === 'true');

                        if (isParticipant) {
                            if (isCompleted) {
                                match.classList.add('match-highlight-completed');
                            } else {
                                match.classList.add('match-highlight');
                            }
                        } else {
                            match.classList.add('match-blocked');
                        }
                    });
                });

                badge.addEventListener('mouseleave', () => {
                    resetMatchStyles(); // Setzt alle Highlight-Stile zur√ºck
                });
                
                badge.addEventListener('click', (e) => {
                    e.stopPropagation(); // Verhindert, dass der Klick auf die Karte auch ausl√∂st
                });
            });

            let activeMatchId = null; // Speichert das aktuell geklickte Match

            // Klick auf Match-Karte -> Zeige alle PARALLEL M√ñGLICHEN Spiele (Gr√ºn)
            matchCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    // Wenn der Klick von einem Badge kam, wurde er schon oben behandelt und gestoppt
                    if (e.target.closest('.badge-hover-target')) {
                        return;
                    }
                    
                    // Wenn das Spiel bereits abgeschlossen ist, soll die Parallel-Logik NICHT greifen.
                    // (Das Bearbeiten des Ergebnisses l√§uft √ºber das Modal und wird separat behandelt)
                    if (card.dataset.completed === 'true') {
                        return;
                    }

                    const currentCardId = card.id; // Jede Karte braucht eine eindeutige ID

                    if (activeMatchId === currentCardId) {
                        // Zweiten Klick auf dasselbe Match -> Deaktivieren
                        activeMatchId = null;
                        resetMatchStyles();
                        card.classList.remove('border-primary'); // Entfernt den Rahmen vom geklickten Match
                    } else {
                        // Anderes Match geklickt oder neues Match aktiviert
                        activeMatchId = currentCardId;
                        resetMatchStyles(); // Alle vorherigen Highlights entfernen
                        card.classList.add('border-primary'); // Hebt das geklickte Match hervor

                        // Wenn das geklickte Spiel fertig ist, keine "Parallel"-Logik anzeigen
                        if (card.dataset.completed === 'true') {
                            return; // Keine weitere Logik f√ºr fertige Spiele
                        }

                        const p1 = card.dataset.player1;
                        const p2 = card.dataset.player2;
                        
                        matchCards.forEach(otherMatch => {
                            if (otherMatch === card) return; // Sich selbst ignorieren
                            if (otherMatch.dataset.completed === 'true') return; // Fertige ignorieren

                            const otherP1 = otherMatch.dataset.player1;
                            const otherP2 = otherMatch.dataset.player2;

                            if (otherP1 !== p1 && otherP1 !== p2 && otherP2 !== p1 && otherP2 !== p2) {
                                // Keine Kollision -> Spielbar!
                                otherMatch.classList.add('match-playable');
                            } else {
                                // Kollision -> Blockiert
                                otherMatch.classList.add('match-blocked');
                            }
                        });
                    }
                });
            });

            function resetMatchStyles() {
                matchCards.forEach(match => {
                    match.classList.remove('match-highlight');
                    match.classList.remove('match-highlight-completed');
                    match.classList.remove('match-playable');
                    match.classList.remove('match-blocked');
                    // Der border-primary wird nur vom click event verwaltet
                });
            }

            function resetClickedMatchStyles() {
                // Diese Funktion wird vom Badge-Hover aufgerufen, um nur die Klick-Highlights zu entfernen
                // bevor die Badge-Highlights angewendet werden
                if (activeMatchId) {
                    document.getElementById(activeMatchId).classList.remove('border-primary');
                    activeMatchId = null;
                }
                matchCards.forEach(match => {
                    match.classList.remove('match-playable');
                    match.classList.remove('match-blocked');
                });
            }
        });
    </script>
{% endblock %}
